﻿@using Microsoft.AspNetCore.Components.Forms
@using System.IO

<div>
    <InputFile OnChange="@HandleFileSelection" multiple />

    @if (imageDataUrls != null && imageDataUrls.Count > 0)
    {
        <div>
            @foreach (var url in imageDataUrls)
            {
                <img src="@url" alt="Uploaded image" style="max-width: 200px; margin: 5px;"/>
            }
        </div>
    }
</div>


@code {
    private List<string> imageDataUrls = new();
    private List<byte[]> imageBytesList = new();

    [Parameter]
    public EventCallback<List<byte[]>> ImageDataBytesChanged { get; set; }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        const long MAXALLOWEDSIZE = 1024 * 100; // Max size per file
        foreach (var file in e.GetMultipleFiles())
        {
            // Check file type and size
            if (!file.ContentType.StartsWith("image/") || file.Size > MAXALLOWEDSIZE)
            {
                continue; // Skip invalid files
            }

            using (var stream = file.OpenReadStream(MAXALLOWEDSIZE))
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();
                imageBytesList.Add(bytes);
                var imageDataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
                imageDataUrls.Add(imageDataUrl);
            }
        }
        await ImageDataBytesChanged.InvokeAsync(imageBytesList);
    }
}