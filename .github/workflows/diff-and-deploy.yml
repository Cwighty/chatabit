name: Diff Check and Redeploy

on:
  workflow_call:
    inputs:
      folder:
        required: true
        type: string
      service:
        required: true
        type: string
    secrets:
      DUCKDNSTOKEN:
        required: true
      POSTGRES_USER:
        required: true
      POSTGRES_PASSWORD:
        required: true
      POSTGRES_DB:
        required: true

jobs:
  diff-check-and-redeploy:
    runs-on: [self-hosted]
    steps:
      - name: checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: check for changes in ${{ inputs.folder }}
        id: diff_check
        run: |
          LAST_DEPLOYED_COMMIT=$(git describe --tags --abbrev=0)
          DIFF=$(git diff --name-only $LAST_DEPLOYED_COMMIT HEAD -- ./${{ inputs.folder }})
          if [ -n "$DIFF" ]; then
            echo "::set-output name=changed::true"
          else
            echo "::set-output name=changed::false"
          fi

      - name: redeploy ${{ inputs.service }} service
        run: |
          if [ "${{ steps.diff_check.outputs.changed }}" = "true" ]; then
            cd ops/prod
            docker compose pull ${{ inputs.service }}
            docker compose build ${{ inputs.service }}
            docker compose down ${{ inputs.service }}
            docker compose up -d ${{ inputs.service }}
          fi

      - name: tag new deployment
        run: |
          if [ "${{ steps.diff_check.outputs.changed }}" = "true" ]; then
            git tag deployed-$(date +%Y%m%d%H%M%S)
            git push origin --tags
          fi
